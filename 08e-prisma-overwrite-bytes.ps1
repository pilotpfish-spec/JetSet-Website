param([string]$ProjectRoot = "C:\website")
$ErrorActionPreference = "Stop"
Set-StrictMode -Version Latest
Set-Location $ProjectRoot

$schemaPath = Join-Path $ProjectRoot "prisma\schema.prisma"

# Exact schema content (UTF-8 no BOM) encoded as Base64 to avoid any PowerShell quoting issues.
$schemaB64 = @'
Z2VuZXJhdG9yIGNsaWVudCB7IHByb3ZpZGVyID0gInByaXNtYS1jbGllbnQtanMiIH0NCg0KZGF0YXNvdXJjZSBkYiB7IA0KICBwcm92aWRlciA9ICJzcWxpdGUiDQogIHVsbCAgICAgID0gImZpbGU6Li9kZXYuZGIiDQp9DQoNCmVudW0gUm9sZSB7IFVTRVIgQURNSU4gfQ0KZW51bSBCb29raW5nU3RhdHVzIHsgUEVORElORyBDT05GSVJNRUQgQ0FOQ0VMTEVEIFJFRlVOREVEIH0N
CmVudW0gTW9kZSB7IFRPX0FJUlBPUlQgRlJPTV9BSVJQT1JUIFBPSU5UX1RPX1BPSU5UIH0NCmVudW0gUHJpY2luZ1N0YXR1cyB7IERSQUZUIFBVQkxJU0hFRCB9DQoNCm1vZGVsIFVzZXIgew0KICBpZCAgICAgICAgICAgIFN0cmluZyAgIGBpZCABZGVmYXVsdChjdWlkKCkpYA0KICBlbWFpbCAgICAgICAgIFN0cmluZyAgIGB1bmlxdWVgDQogIHBhc3N3b3JkSGFzaCAgIFN0cmluZw0KICBuYW1lICAgICAgICAgIFN0cmluZz8NCiAgcGhvbmUgICAgICAgICBTdHJpbmc/DQogIHN0cmlwZUN1c3RvbWVySWQgU3RyaW5nPw0KICByb2xlICAgICAgICAgICBSb2xlICAgICBkZWZhdWx0KFVTRVIpDQogIGNyZWF0ZWRBdCAgICAgIERhdGVUaW1lIGBkZWZhdWx0KG5vdygpKWBNCiAgbGFzdExvZ2luICAgICAgIERhdGVUaW1lPw0KICBhZGRyZXNzZXMgICAgICAgQWRkcmVzc1tdDQogIHBheW1lbnRNZXRob2RzICAgUGF5bWVudE1ldGhvZFtdDQogIHF1b3RlcyAgICAgICAgICBRdW90ZVtdDQogIGJvb2tpbmdzICAgICAgICBCb29raW5nW10NCiAgYXVkaXRMb2dzICAgICAgIEF1ZGl0TG9nW10gQHJlbGF0aW9uKCJVc2VyQXVkaXRMb2dzIikNCn0NCg0KbW9kZWwgQWRkcmVzcyB7DQogIGlkICAgICAgICAgICBTdHJpbmcgICBgaWRgIEBkZWZhdWx0KGN1aWQoKSlgDQogIHVzZXIgICAgICAgICAgVXNlcj8gICAgQH
JlbGF0aW9uKGZpZWxkczogW3VzZXJJZF0sIHJlZmVyZW5jZXM6IFtpZF0pKQ0KICB1c2VySWQgICAgICAgICBTdHJpbmc/DQogIGxhYmVsICAgICAgICAgU3RyaW5nPw0KICBmdWxsQWRkcmVzcyBTdHJpbmcNCiAgbGF0ICAgICAgICAgICBGbG9hdA0KICBsbmcgICAgICAgICAgIEZsb2F0DQogIGlzRGVmYXVsdCAgICAgIEJvb2xlYW4gIEBkZWZhdWx0KGZhbHNlKQ0KICBsYXN0VXNlZCAgICAgICBEYXRlVGltZSBAZGVmYXVsdChub3coKSlNCn0NCg0KbW9kZWwgUGF5bWVudE1ldGhvZCB7DQogIGlkICAgICAgICBTdHJpbmcgIEBpZCBAZGVmYXVsdChjdWlkKCkpDQogIHVzZXIgICAgICAgVXNlciAgICBAcmVsYXRpb24oZmllbGRzOiBbdXNlcklkXSwgcmVmZXJlbmNlczogW2lkXSkNCiAgdXNlcklkICAgICBTdHJpbmcNCiAgc3RyaXBlUG1JZCBTdHJpbmcgIEB1bmlxdWUNCiAgYnJhbmQgICAgICBTdHJpbmcNCiAgbGFzdDQgICAgICBTdHJpbmcNCiAgZXhwbW9udGggIEludA0KICBleHBZZWFyICAgIEludA0KICBpc0RlZmF1bHQgIEJvb2xlYW4gQGRlZmF1bHQoZmFsc2UpDQp9DQoNCm1vZGVsIFF1b3RlIHsNCiAgaWQgICAgICAgICAgICAgU3RyaW5nICAgQGlkIEBkZWZhdWx0KGN1aWQoKSlNCiAgdXNlciAgICAgICAgICAgIFVzZXI/ICAgIEByZWxhdGlvbihmaWVsZHM6IFt1c2VySWRdLCByZWZlcmVuY2VzOiBbaWRdKSkNCiAgdXNlcklkICAgICAgICAgIFN0cmluZz8NCiAgbW9kZSAgICAgICAgICAgIE1vZGUNCiAgb3JpZ2luQWRkcmVzcyAgIFN0cmluZw0KICBvcmlnaW5MYXQgICAgICAgRmxvYXQNCiAgb3JpZ2luTG5nICAgICAgIEZsb2F0DQogIGRlc3RBZGRyZXNzICAgIFN0cmluZw0KICBkZXN0TGF0ICAgICAgICBGbG9hdA0KICBkZXN0TG5nICAgICAgICBGbG9hdA0KICBkaXN0YW5jZU1ldGVycyAgIEludA0KICBkdXJhdGlvblNlY29uZHMgIEludA0KICBicmVha2Rvd25Kc29uICAgSnNvbg0KICB0b3RhbENlbnRzICAgICAgSW50DQogIGV4cGlyZXNBdCAgICAgIERhdGVUaW1lDQogIGNyZWF0ZWRBdCAgICAgIERhdGVUaW1lIEBkZWZhdWx0KG5vdygpKQ0KfQ0KDQptb2RlbCBCb29raW5nIHsNCiAgaWQgICAgICAgICAgICAgU3RyaW5nICAgICAgIEBpZCBAZGVmYXVsdChjdWlkKCkpDQogIHVzZXIgICAgICAgICAgIFVzZXIgICAgICAgQH
JlbGF0aW9uKGZpZWxkczogW3VzZXJJZF0sIHJlZmVyZW5jZXM6IFtpZF0pDQogIHVzZXJJZCAgICAgICAgICBTdHJpbmcNCiAgcXVvdGUgICAgICAgICAgIFF1b3RlICAgICAgIEByZWxhdGlvbihmaWVsZHM6IFtxdW90ZUlkXSwgcmVmZXJlbmNlczogW2lkXSkNCiAgcXVvdGVJZCAgICAgICAgICBTdHJpbmcNCiAgc3RhdHVzICAgICAgICAgIEJvb2tpbmdTdGF0dXMgIEBkZWZhdWx0KFJFTkRJTkcpDQogIHBpY2t1cEF0ICAgICAgICBEYXRlVGltZQ0KICBwYXggICAgICAgICAgICAgSW50DQogIGJhZ3MgICAgICAgICAgICBJbnQNCiAgbm90ZXMgICAgICAgICAgIFN0cmluZz8NCiAgdG90YWxDZW50cyAgICAgICBJbnQNCiAgc3RyaXBlUGF5bWVudEludGVudElkICBTdHJpbmc/DQogIGNyZWF0ZWRBdCAgICAgICAgRGF0ZVRpbWUgICAgICAgQGRlZmF1bHQobm93KCkpDQp9DQoNCm1vZGVsIFByaWNpbmdDb25maWcgew0KICBpZCAgICAgICAgICAgICAgU3RyaW5nICAgICAgICAgQGlkIEBkZWZhdWx0KGN1aWQoKSlNCiAgdmVyc2lvbiAgICAgICAgICAgSW50DQogIHN0YXR1cyAgICAgICAgICAgICBQcmljaW5nU3RhdHVzICBAZGVmYXVsdChEUkFGVCkNCiAgdG9Gcm9tQWlycG9ydCAgICAgICBKc29uDQogIHBvaW50VG9Qb2ludCAgICAgICAgSnNvbg0KICBhaXJwb3J0T3ZlcnJpZGVzIEpzb24/DQogIGNyZWF0ZWRCeSAgICAgICAgICAgVXNlciAgICAgICAgICBAcmVsYXRpb24oZmllbGRzOiBbY3JlYXRlZEJ5VXNlcklkXSwgcmVmZXJlbmNlczogW2lkXSkNCiAgY3JlYXRlZEJ5VXNlcklkIFN0cmluZw0KICBwdWJsaXNoZWRBdCAgICAgICAgIERhdGVUaW1lPw0KICBjcmVhdGVkQXQgICAgICAgICAgIERhdGVUaW1lICAgICAgIEBkZWZhdWx0KG5vdygpKQ0KfQ0KDQptb2RlbCBBdWRpdExvZyB7DQogIGlkICAgICAgICAgU3RyaW5nICAgQGlkIEBkZWZhdWx0KGN1aWQoKSlNCiAgYWN0b3IgICAgICAgIFVzZXI/ICBAcmVsYXRpb24oIlVzZXJBdWRpdExvZ3MiLCBmaWVsZHM6IFthY3RvclVzZXJJZF0sIHJlZmVyZW5jZXM6IFtpZF0pDQogIGFjdG9yVXNlcklkICBTdHJpbmc/DQogIGFjdGlvbiAgICAgICAgU3RyaW5nDQogIHRhcmdldFR5cGUgICAgU3RyaW5nDQogIHRhcmdldElkICAgICAgIFN0cmluZz8NCiAgbWV0YWRhdGEgICAgICAgSnNvbj8NCiAgY3JlYXRlZEF0ICAgICAgIERhdGVUaW1lIGBkZWZhdWx0KG5vdygpYg0KfQ0K
'@

# 1) Decode and write bytes (UTF-8, no BOM)
[byte[]]$bytes = [Convert]::FromBase64String($schemaB64)
[System.IO.File]::WriteAllBytes($schemaPath, $bytes)

# 2) Format + generate via npx.cmd (avoid npm.ps1 issues)
$npxCmd = Join-Path $env:ProgramFiles "nodejs\npx.cmd"
if (!(Test-Path $npxCmd)) { throw "npx.cmd not found at $npxCmd" }

& $npxCmd prisma format
if ($LASTEXITCODE -ne 0) { throw "prisma format failed (code $LASTEXITCODE)" }

& $npxCmd prisma generate
if ($LASTEXITCODE -ne 0) { throw "prisma generate failed (code $LASTEXITCODE)" }

Write-Host "OK: schema.prisma replaced (UTF-8 no BOM), formatted, and Prisma client generated."
